services:
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-simplify}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-simplify}"]
      interval: 10s
      timeout: 5s
      retries: 8
      start_period: 10s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PORT: 8787
      APP_BASE_URL: ${APP_BASE_URL:-http://localhost:4173}
      FRONTEND_ORIGINS: ${FRONTEND_ORIGINS:-http://localhost:4173}
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-simplify}
      POSTGRES_SSL: "false"
      OPENAI_API_BASE: ${OPENAI_API_BASE:-https://api.openai.com/v1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4.1-mini}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_PRICE_ONE: ${STRIPE_PRICE_ONE:-}
      STRIPE_PRICE_PACK: ${STRIPE_PRICE_PACK:-}
      STRIPE_PRICE_SUB: ${STRIPE_PRICE_SUB:-}
      JWT_SECRET: ${JWT_SECRET:-change-me-docker-jwt-secret}
      ADMIN_API_KEY: ${ADMIN_API_KEY:-change-me-docker-admin-key}
      OTP_PEPPER: ${OTP_PEPPER:-change-me-docker-otp-pepper}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      LEGAL_VERSION: ${LEGAL_VERSION:-2026-02}
      LEGAL_REQUIRE_CHECKOUT_CONSENT: ${LEGAL_REQUIRE_CHECKOUT_CONSENT:-1}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_SECURE: ${SMTP_SECURE:-false}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@simplify.local}
      SHOW_DEV_OTP: ${SHOW_DEV_OTP:-0}
      PRICE_CURRENCY: ${PRICE_CURRENCY:-eur}
      PRICE_ONE_CENTS: ${PRICE_ONE_CENTS:-100}
      PRICE_PACK_CENTS: ${PRICE_PACK_CENTS:-500}
      PRICE_SUB_CENTS: ${PRICE_SUB_CENTS:-800}
      CREDIT_ONE: ${CREDIT_ONE:-1}
      CREDIT_PACK: ${CREDIT_PACK:-10}
      CREDIT_SUB_MONTH: ${CREDIT_SUB_MONTH:-250}
      FREE_USES: ${FREE_USES:-3}
    ports:
      - "${BACKEND_PORT:-8787}:8787"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8787/api/health >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 25s

  frontend:
    image: nginx:1.27-alpine
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "${FRONTEND_PORT:-4173}:80"
    volumes:
      - ./simplify/public:/usr/share/nginx/html:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1/ >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 10s

  pgbackups:
    image: prodrigestivill/postgres-backup-local:17
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_DB: ${POSTGRES_DB:-simplify}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_EXTRA_OPTS: "--clean --if-exists"
      SCHEDULE: ${BACKUP_SCHEDULE:-@daily}
      BACKUP_KEEP_DAYS: ${BACKUP_KEEP_DAYS:-14}
      BACKUP_KEEP_WEEKS: ${BACKUP_KEEP_WEEKS:-8}
      BACKUP_KEEP_MONTHS: ${BACKUP_KEEP_MONTHS:-6}
      HEALTHCHECK_PORT: 8080
    volumes:
      - pg_backups:/backups
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8080/ >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 6
      start_period: 20s

volumes:
  pg_data:
  pg_backups:
